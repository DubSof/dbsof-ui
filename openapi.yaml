openapi: 3.1.0
info:
  title: UI Template API
  version: 1.0.0
  description: Minimal CRUD-style endpoints to support SQL execution, schema exploration, data browsing, and AI task flows.
servers:
  - url: http://localhost:5757
    description: Local dev API
tags:
  - name: Instances
  - name: SQL
  - name: Schema
  - name: Data
  - name: AI
  - name: Imports
  - name: Users
paths:
  /instances:
    get:
      tags: [Instances]
      summary: List instances
      responses:
        "200":
          description: Instances available to the user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Instance"

  /instances/{instanceId}/databases:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
    get:
      tags: [Instances]
      summary: List databases (branches) for an instance
      responses:
        "200":
          description: Databases for the instance
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Database"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Database"
    post:
      tags: [Instances]
      summary: Create a new database (branch)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DatabaseCreate"
      responses:
        "201":
          description: Database created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Database"
        "400":
          description: Invalid request (e.g., duplicate name, invalid name)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /instances/{instanceId}/databases/{database}/migrations:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    get:
      tags: [Instances]
      summary: Get migration history for a database (branch)
      responses:
        "200":
          description: Migration history for the database
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Migration"
        "404":
          description: Instance or database not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /users/{userId}/settings:
    parameters:
      - $ref: "#/components/parameters/UserId"
    get:
      tags: [Users]
      summary: Get user settings
      description: Retrieve all settings for a specific user
      responses:
        "200":
          description: User settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSettings"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    put:
      tags: [Users]
      summary: Update user settings
      description: Update settings for a specific user. Merges with existing settings.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserSettings"
      responses:
        "200":
          description: Updated user settings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserSettings"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "500":
          description: Server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /instances/{instanceId}/databases/{database}/sql/commands:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    post:
      tags: [SQL]
      summary: Execute a SQL command (REPL/editor)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SqlCommandRequest"
      responses:
        "200":
          description: Command executed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SqlCommandResult"
        "400":
          description: SQL execution error
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /instances/{instanceId}/databases/{database}/sql/history:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
      - in: query
        name: limit
        schema: {type: integer, minimum: 1, maximum: 200, default: 50}
      - in: query
        name: cursor
        schema: {type: string, description: Opaque cursor for pagination}
    get:
      tags: [SQL]
      summary: Fetch SQL command history
      responses:
        "200":
          description: Historical commands
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/SqlHistoryItem"
                  nextCursor:
                    type: string
                    nullable: true
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: "#/components/schemas/SqlHistoryItem"
                  nextCursor:
                    type: string
                    nullable: true

  /instances/{instanceId}/databases/{database}/schema:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    get:
      tags: [Schema]
      summary: Get database schema (for text/graph views)
      responses:
        "200":
          description: Schema overview
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchemaSnapshot"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SchemaSnapshot"

  /instances/{instanceId}/databases/{database}/tables:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    get:
      tags: [Data]
      summary: List tables for data explorer
      responses:
        "200":
          description: Tables and basic stats
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TableSummary"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TableSummary"

  /instances/{instanceId}/databases/{database}/tables/{table}/schema:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
      - $ref: "#/components/parameters/Table"
    get:
      tags: [Data]
      summary: Get table schema
      responses:
        "200":
          description: Column definitions and relationships
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TableSchema"
        "404":
          description: Instance or table not found
          content:
            application/json:
              schema:
                type: object
                properties: {}

  /instances/{instanceId}/databases/{database}/tables/{table}/rows:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
      - $ref: "#/components/parameters/Table"
      - in: query
        name: limit
        schema: {type: integer, minimum: 1, maximum: 500, default: 100}
      - in: query
        name: offset
        schema: {type: integer, minimum: 0, default: 0}
      - in: query
        name: where
        schema: {type: string, description: Optional SQL WHERE fragment}
      - in: query
        name: orderBy
        schema: {type: string, description: Optional SQL ORDER BY fragment}
    get:
      tags: [Data]
      summary: Fetch table rows for explorer
      responses:
        "200":
          description: Tabular data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TableRowsPage"
        "404":
          description: Instance or table not found
          content:
            application/json:
              schema:
                type: object
                properties: {}

  /instances/{instanceId}/databases/{database}/ai/tasks:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    post:
      tags: [AI]
      summary: Create a new program build task (alias)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AiProgramCreate"
      responses:
        "202":
          description: Task accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AiTaskWithProgram"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    get:
      tags: [AI]
      summary: List AI tasks
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pending, running, failed, completed]
      responses:
        "200":
          description: Tasks for the database
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AiTask"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AiTask"

  /instances/{instanceId}/databases/{database}/ai/programs:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    post:
      tags: [AI]
      summary: Create a new program build request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AiProgramCreate"
      responses:
        "202":
          description: Program build accepted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AiTaskWithProgram"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    get:
      tags: [AI]
      summary: List programs
      responses:
        "200":
          description: Programs for the database
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AiProgram"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AiProgram"

  /instances/{instanceId}/databases/{database}/ai/programs/{programId}:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
      - $ref: "#/components/parameters/ProgramId"
    get:
      tags: [AI]
      summary: Get program details/graph
      responses:
        "200":
          description: Program details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AiProgram"
        "404":
          description: Instance or program not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /instances/{instanceId}/databases/{database}/ai/tasks/{taskId}:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
      - $ref: "#/components/parameters/TaskId"
    get:
      tags: [AI]
      summary: Get AI task status/output
      responses:
        "200":
          description: Task details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AiTaskWithProgram"
        "404":
          description: Instance or task not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /instances/{instanceId}/databases/{database}/imports:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
    post:
      tags: [Imports]
      summary: Create a new import job
      requestBody:
        required: false
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Import job name
                source:
                  type: string
                  enum: [CSV upload, JSON upload, API pull, Database sync, upload, manual]
                  default: CSV upload
                notes:
                  type: string
                  description: Optional notes about the import
                rows:
                  type: integer
                  description: Expected number of rows
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Files to import (CSV format)
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                source:
                  type: string
                  enum: [CSV upload, JSON upload, API pull, Database sync, upload, manual]
                notes:
                  type: string
                rows:
                  type: integer
      responses:
        "202":
          description: Import job created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImportJob"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
    get:
      tags: [Imports]
      summary: List import jobs for a database
      responses:
        "200":
          description: List of import jobs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ImportJob"
        "404":
          description: Instance not found
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ImportJob"

  /instances/{instanceId}/databases/{database}/imports/{jobId}:
    parameters:
      - $ref: "#/components/parameters/InstanceId"
      - $ref: "#/components/parameters/Database"
      - $ref: "#/components/parameters/JobId"
    get:
      tags: [Imports]
      summary: Get import job details
      responses:
        "200":
          description: Import job details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ImportJob"
        "404":
          description: Instance or job not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

components:
  parameters:
    InstanceId:
      in: path
      name: instanceId
      required: true
      schema: {type: string}
    Database:
      in: path
      name: database
      required: true
      schema: {type: string}
    Table:
      in: path
      name: table
      required: true
      schema: {type: string}
    ProgramId:
      in: path
      name: programId
      required: true
      schema: {type: string}
    TaskId:
      in: path
      name: taskId
      required: true
      schema: {type: string}
    JobId:
      in: path
      name: jobId
      required: true
      schema: {type: string}
    UserId:
      in: path
      name: userId
      required: true
      schema: {type: string}
      description: User identifier (username)

  schemas:
    Instance:
      type: object
      properties:
        id: {type: string}
        name: {type: string}
    Database:
      type: object
      properties:
        name: {type: string}
        lastMigration: {type: string, nullable: true}
    DatabaseCreate:
      type: object
      required: [name]
      properties:
        name:
          type: string
          description: Name of the database/branch to create
          pattern: ^[^@][^@]*$
        fromBranch:
          type: string
          nullable: true
          description: Optional source branch to copy from
        copyData:
          type: boolean
          default: false
          description: If true and fromBranch is provided, copy data in addition to schema
    Migration:
      type: object
      properties:
        id:
          type: string
          description: Unique migration identifier
        name:
          type: string
          description: Migration name (e.g., "0001-demo")
        parentId:
          type: string
          nullable: true
          description: ID of the parent migration, null for root migrations
    UserSettings:
      type: object
      description: User settings object. Can contain any key-value pairs for user preferences.
      additionalProperties: true
      example:
        theme: "dark"
        language: "en"
        editorFontSize: 14
        autoSave: true
    SqlCommandRequest:
      type: object
      required: [query]
      properties:
        query:
          type: string
          description: SQL text to execute
        params:
          type: object
          additionalProperties:
            type: object
            properties:
              typeName: {type: string}
              value: {}
        mode:
          type: string
          enum: [raw, tabular]
          default: tabular
          description: raw = REPL/plain text; tabular = structured rows
    SqlCommandResult:
      type: object
      properties:
        id: {type: string}
        status: {type: string}
        durationMs: {type: number}
        columns:
          type: array
          items: {type: string}
        rows:
          type: array
          items:
            type: array
            items: {}
        rawText:
          type: string
          description: Present when mode=raw
        warnings:
          type: array
          items: {type: string}
    SqlHistoryItem:
      type: object
      properties:
        id: {type: string}
        query: {type: string}
        params:
          type: object
          additionalProperties: {}
        status: {type: string}
        createdAt: {type: string, format: date-time}
        durationMs: {type: number}
    SchemaSnapshot:
      type: object
      properties:
        types:
          type: array
          items:
            type: object
            properties:
              name: {type: string}
              kind: {type: string, enum: [table, view, function, scalar, enum]}
              module: {type: string}
              references:
                type: array
                items:
                  type: object
                  properties:
                    target: {type: string}
                    type: {type: string, enum: [link, dependency]}
        version: {type: string}
    TableSummary:
      type: object
      properties:
        name: {type: string}
        rowCount: {type: integer, nullable: true}
        columns:
          type: array
          items:
            $ref: "#/components/schemas/TableColumn"
    TableSchema:
      type: object
      properties:
        name: {type: string}
        columns:
          type: array
          items:
            $ref: "#/components/schemas/TableColumn"
        indexes:
          type: array
          items:
            type: object
            properties:
              name: {type: string}
              expression: {type: string}
        primaryKey:
          type: array
          items: {type: string}
    TableColumn:
      type: object
      properties:
        name: {type: string}
        type: {type: string}
        nullable: {type: boolean}
        default: {type: string, nullable: true}
    TableRowsPage:
      type: object
      properties:
        columns:
          type: array
          items: {type: string}
        rows:
          type: array
          items:
            type: array
            items: {}
        total:
          type: integer
          nullable: true
    ProgramGraphNode:
      type: object
      properties:
        id: {type: string}
        label: {type: string}
        status: {type: string, enum: [pending, in-progress, done]}
    ProgramGraphEdge:
      type: object
      properties:
        from: {type: string}
        to: {type: string}
        label: {type: string}
    ProgramGraph:
      type: object
      properties:
        nodes:
          type: array
          items: {$ref: "#/components/schemas/ProgramGraphNode"}
        edges:
          type: array
          items: {$ref: "#/components/schemas/ProgramGraphEdge"}
    AiProgramCreate:
      type: object
      required: [feature]
      properties:
        feature:
          type: string
          description: User request / feature description
        name:
          type: string
          description: Optional friendly name
    AiTask:
      type: object
      properties:
        id: {type: string}
        programId: {type: string}
        status:
          type: string
          enum: [pending, running, failed, completed]
        prompt: {type: string}
        createdAt: {type: string, format: date-time}
        completedAt: {type: string, format: date-time, nullable: true}
    AiProgram:
      type: object
      properties:
        id: {type: string}
        feature: {type: string}
        status: {type: string, enum: [building, ready, failed]}
        createdAt: {type: string, format: date-time}
        updatedAt: {type: string, format: date-time}
        graph:
          $ref: "#/components/schemas/ProgramGraph"
    AiTaskWithProgram:
      type: object
      properties:
        task:
          $ref: "#/components/schemas/AiTask"
        program:
          $ref: "#/components/schemas/AiProgram"
    ImportJob:
      type: object
      properties:
        id:
          type: string
          description: Unique job identifier
        name:
          type: string
          description: Import job name
        source:
          type: string
          enum: [CSV upload, JSON upload, API pull, Database sync, upload, manual]
          description: Source of the import
        status:
          type: string
          enum: [running, completed, failed]
          description: Current job status
        progress:
          type: number
          minimum: 0
          maximum: 100
          description: Progress percentage (0-100)
        createdAt:
          type: string
          format: date-time
          description: Job creation timestamp
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: Job completion timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
        rows:
          type: integer
          nullable: true
          description: Number of rows imported
        notes:
          type: string
          description: Optional notes about the import
        files:
          type: array
          items:
            type: object
            properties:
              filename:
                type: string
              size:
                type: integer
                description: File size in bytes
          description: List of files associated with the import